- name: 2.2.1.1 Ensure time synchronization is in use (Not Scored) 1/2
  yum:
    name: "{% if time_sync_service == 'ntp' %}chrony{% else %}ntp{% endif %}"
    state: absent
  tags: [ level 1 server, level 1 workstation ]

- name: 2.2.1.1 Ensure time synchronization is in use (Not Scored) 2/2
  yum:
    name: "{{ time_sync_service }}"
    state: present
  tags: [ level 1 server, level 1 workstation ]

- name: 2.2.1.2 Ensure ntp is configured 1/2 – /etc/ntp.conf
  blockinfile:
    path: /etc/ntp.conf
    block: |
      restrict -4 default kod nomodify notrap nopeer noquery
      restrict -6 default kod nomodify notrap nopeer noquery
  when: time_sync_service == 'ntp'
  tags: [ level 1 server, level 1 workstation ]

- name: 2.2.1.2 Ensure ntp is configured 2/2 – /etc/sysconfig/ntpd
  ini_file:
    path: /etc/sysconfig/ntpd
    section: null
    option: OPTIONS
    value: '"-u ntp:ntp"'
    no_extra_spaces: yes
  when: time_sync_service == 'ntp'
  tags: [ level 1 server, level 1 workstation ]

- name: 2.2.1.3 Ensure chrony is configured (Scored)
  ini_file:
    path: /etc/sysconfig/chronyd
    section: null
    option: OPTIONS
    value: '"-u chrony"'
    no_extra_spaces: yes
  when: time_sync_service == 'chrony'
  tags: [ level 1 server, level 1 workstation ]

- name: 2.2.2 Ensure X Window System is not installed (Scored)
  yum:
    name: xorg-x11*
    state: absent
  tags: [ level 1 server ]

- name: 2.2.3,2.2.5-14,2.2.16-21 Ensure unused services are not enabled (Scored)
  shell: "systemctl is-enabled {{ item }} | grep -vq 'enabled' && systemctl disable {{ item }}"
  register: result
  failed_when: False
  changed_when: result.rc == 0
  loop: "{{ services_to_disable }}"
  tags: [ level 1 server, level 1 workstation ]

- name: 2.2.4 Ensure CUPS is not enabled (Scored)
  shell: "systemctl is-enabled cups | grep -vq 'enabled' && systemctl disable cups"
  register: result
  failed_when: False
  changed_when: result.rc == 0
  tags: [ level 1 server, level 2 workstation ]

- name: 2.2.15 Ensure mail transfer agent is configured for local-only mode (Scored)
  ini_file:
    path: /etc/postfix/main.cf
    section: RECEIVING MAIL
    option: inet_interfaces
    value: loopback-only
  tags: [ level 1 server, level 1 workstation ]
